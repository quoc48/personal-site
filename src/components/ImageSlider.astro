---
interface Props {
  images: string[];
  alts?: string[];
  class?: string;
  aspectRatio?: 'auto' | 'portrait' | 'landscape' | 'square';
}

const { images = [], alts = [], class: className = '', aspectRatio = 'auto' } = Astro.props;

// Preset aspect ratios for manual override
const aspectRatioClasses = {
  portrait: 'aspect-[3/4]',
  landscape: 'aspect-[16/9]',
  square: 'aspect-square',
  auto: '', // Will be calculated by JS
};
---

<div class={`image-slider relative bg-black ${className}`} data-aspect-ratio={aspectRatio}>
  <!-- Main Images Container -->
  <div class={`slider-track relative w-full overflow-hidden ${aspectRatio !== 'auto' ? aspectRatioClasses[aspectRatio] : 'min-h-[250px] md:min-h-[300px]'}`}>
    {images.map((image, index) => (
      <div
        class={`slide absolute inset-0 flex items-center justify-center p-2 md:p-4 transition-opacity duration-300 ${index === 0 ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
        data-index={index}
      >
        <img
          src={image}
          alt={alts[index] || `Slide ${index + 1}`}
          class="slide-image max-w-full max-h-full w-auto h-auto object-contain"
          loading={index === 0 ? 'eager' : 'lazy'}
        />
      </div>
    ))}

    <!-- Fullscreen Toggle Button -->
    <button
      class="fullscreen-btn absolute top-2 md:top-3 right-2 md:right-3 w-8 h-8 bg-black/50 hover:bg-black/70 rounded flex items-center justify-center transition-colors z-10 focus:outline-none"
      aria-label="Toggle fullscreen"
    >
      <!-- Expand Icon (arrows pointing outward) -->
      <svg class="expand-icon w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4h4M4 4l5 5M20 8V4h-4M20 4l-5 5M4 16v4h4M4 20l5-5M20 16v4h-4M20 20l-5-5"/>
      </svg>
      <!-- Minimize Icon (arrows pointing inward) - hidden by default -->
      <svg class="minimize-icon w-5 h-5 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 4v4H5M9 8L4 3M15 4v4h4M15 8l5-5M9 20v-4H5M9 16l-5 5M15 20v-4h4M15 16l5 5"/>
      </svg>
    </button>
  </div>

  <!-- Navigation Arrows -->
  <div class="arrows-container absolute inset-x-0 top-0 bottom-[56px] md:bottom-[64px] flex items-center justify-between px-2 md:px-3 pointer-events-none">
    <!-- Left Arrow -->
    <button
      class="arrow-left pointer-events-auto w-[36px] h-[36px] md:w-[40px] md:h-[40px] bg-black/60 hover:bg-black/80 backdrop-blur-sm rounded-full flex items-center justify-center transition-colors focus:outline-none shadow-lg"
      aria-label="Previous slide"
    >
      <svg width="14" height="14" class="md:w-4 md:h-4" viewBox="0 0 12 12" fill="none">
        <path d="M8 2L4 6L8 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <!-- Right Arrow -->
    <button
      class="arrow-right pointer-events-auto w-[36px] h-[36px] md:w-[40px] md:h-[40px] bg-black/60 hover:bg-black/80 backdrop-blur-sm rounded-full flex items-center justify-center transition-colors focus:outline-none shadow-lg"
      aria-label="Next slide"
    >
      <svg width="14" height="14" class="md:w-4 md:h-4" viewBox="0 0 12 12" fill="none">
        <path d="M4 2L8 6L4 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <!-- Thumbnail Strip -->
  <div class="thumbnails-container flex items-center justify-start md:justify-center gap-1.5 md:gap-2 py-2 md:py-3 px-2 md:px-0 bg-black overflow-x-auto scrollbar-hide">
    {images.map((image, index) => (
      <button
        class={`thumbnail relative overflow-hidden rounded transition-all cursor-pointer focus:outline-none flex-shrink-0 ${index === 0 ? 'ring-2 ring-[#3d5af1] opacity-100' : 'opacity-50 hover:opacity-75'}`}
        data-index={index}
        aria-label={`Go to slide ${index + 1}`}
      >
        <img
          src={image}
          alt={alts[index] || `Thumbnail ${index + 1}`}
          class="w-12 h-8 md:w-16 md:h-10 object-cover"
        />
      </button>
    ))}
  </div>
</div>

<style>
  /* Hide scrollbar but allow scrolling */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Fullscreen mode */
  .image-slider.fullscreen {
    position: fixed !important;
    inset: 0 !important;
    z-index: 9999 !important;
    max-width: none !important;
    width: 100vw !important;
    height: 100vh !important;
  }

  .image-slider.fullscreen .slider-track {
    height: calc(100vh - 64px) !important;
    aspect-ratio: unset !important;
    min-height: unset !important;
  }

  .image-slider.fullscreen .arrows-container {
    bottom: 64px !important;
  }

  .image-slider.fullscreen .expand-icon {
    display: none;
  }

  .image-slider.fullscreen .minimize-icon {
    display: block;
  }
</style>

<script>
  function initImageSliders() {
    const sliders = document.querySelectorAll('.image-slider');

    sliders.forEach((slider) => {
      // Skip if already initialized
      if (slider.getAttribute('data-initialized')) return;
      slider.setAttribute('data-initialized', 'true');

      const sliderTrack = slider.querySelector('.slider-track') as HTMLElement;
      const slides = slider.querySelectorAll('.slide');
      const thumbnails = slider.querySelectorAll('.thumbnail');
      const arrowLeft = slider.querySelector('.arrow-left');
      const arrowRight = slider.querySelector('.arrow-right');
      const fullscreenBtn = slider.querySelector('.fullscreen-btn');
      const aspectRatioMode = slider.getAttribute('data-aspect-ratio');

      if (slides.length === 0) return;

      // Auto-detect aspect ratio from first image
      if (aspectRatioMode === 'auto' && sliderTrack) {
        const firstImage = slider.querySelector('.slide-image') as HTMLImageElement;

        const setDynamicHeight = () => {
          if (firstImage.naturalWidth && firstImage.naturalHeight) {
            const aspectRatio = firstImage.naturalWidth / firstImage.naturalHeight;
            const containerWidth = sliderTrack.offsetWidth - 32; // Account for padding
            let calculatedHeight = containerWidth / aspectRatio;

            // Clamp height between 250px and 500px on mobile, 300px and 600px on desktop
            const isMobile = window.innerWidth < 768;
            const minHeight = isMobile ? 250 : 300;
            const maxHeight = isMobile ? 450 : 600;
            calculatedHeight = Math.max(minHeight, Math.min(maxHeight, calculatedHeight));

            sliderTrack.style.height = `${calculatedHeight}px`;
            sliderTrack.style.minHeight = 'unset';
          }
        };

        if (firstImage.complete) {
          setDynamicHeight();
        } else {
          firstImage.addEventListener('load', setDynamicHeight);
        }

        // Recalculate on window resize
        window.addEventListener('resize', () => {
          if (!slider.classList.contains('fullscreen')) {
            setDynamicHeight();
          }
        });
      }

      let currentIndex = 0;

      const showSlide = (index: number) => {
        // Wrap around
        if (index < 0) index = slides.length - 1;
        if (index >= slides.length) index = 0;

        // Update slides
        slides.forEach((slide, i) => {
          if (i === index) {
            slide.classList.remove('opacity-0', 'pointer-events-none');
            slide.classList.add('opacity-100');
          } else {
            slide.classList.add('opacity-0', 'pointer-events-none');
            slide.classList.remove('opacity-100');
          }
        });

        // Update thumbnails
        thumbnails.forEach((thumb, i) => {
          if (i === index) {
            thumb.classList.remove('opacity-50');
            thumb.classList.add('ring-2', 'ring-[#3d5af1]', 'opacity-100');
          } else {
            thumb.classList.add('opacity-50');
            thumb.classList.remove('ring-2', 'ring-[#3d5af1]', 'opacity-100');
          }
        });

        // Scroll thumbnail into view on mobile
        const activeThumb = thumbnails[index] as HTMLElement;
        if (activeThumb) {
          activeThumb.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        }

        currentIndex = index;
      };

      // Arrow navigation
      arrowLeft?.addEventListener('click', () => showSlide(currentIndex - 1));
      arrowRight?.addEventListener('click', () => showSlide(currentIndex + 1));

      // Thumbnail navigation
      thumbnails.forEach((thumb, index) => {
        thumb.addEventListener('click', () => showSlide(index));
      });

      // Touch swipe support
      let touchStartX = 0;
      let touchEndX = 0;

      sliderTrack?.addEventListener('touchstart', (e) => {
        touchStartX = (e as TouchEvent).changedTouches[0].screenX;
      }, { passive: true });

      sliderTrack?.addEventListener('touchend', (e) => {
        touchEndX = (e as TouchEvent).changedTouches[0].screenX;
        const swipeThreshold = 50;
        
        if (touchStartX - touchEndX > swipeThreshold) {
          // Swiped left, go to next
          showSlide(currentIndex + 1);
        } else if (touchEndX - touchStartX > swipeThreshold) {
          // Swiped right, go to previous
          showSlide(currentIndex - 1);
        }
      }, { passive: true });

      // Fullscreen toggle
      fullscreenBtn?.addEventListener('click', () => {
        slider.classList.toggle('fullscreen');

        // If entering fullscreen, also use native fullscreen API
        if (slider.classList.contains('fullscreen')) {
          if (document.fullscreenElement) {
            // Already in fullscreen, do nothing extra
          } else if (slider.requestFullscreen) {
            slider.requestFullscreen().catch(() => {
              // Fallback to CSS-only fullscreen if API fails
            });
          }
        } else {
          if (document.fullscreenElement) {
            document.exitFullscreen();
          }
        }
      });

      // Handle keyboard navigation
      document.addEventListener('keydown', (e) => {
        // ESC to exit fullscreen
        if (e.key === 'Escape' && slider.classList.contains('fullscreen')) {
          slider.classList.remove('fullscreen');
        }

        // Arrow keys for navigation (only in fullscreen mode)
        if (slider.classList.contains('fullscreen')) {
          if (e.key === 'ArrowLeft') {
            e.preventDefault();
            showSlide(currentIndex - 1);
          } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            showSlide(currentIndex + 1);
          }
        }
      });

      // Sync with native fullscreen exit
      document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement && slider.classList.contains('fullscreen')) {
          slider.classList.remove('fullscreen');
        }
      });
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initImageSliders);
  document.addEventListener('astro:page-load', initImageSliders);

  // Also run immediately in case DOM is already ready
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(initImageSliders, 0);
  }
</script>
